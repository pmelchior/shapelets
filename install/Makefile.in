# PATHs are filled by local.py
???PATHS???

ARCH = $(shell uname -m)
DOCPATH = $(INSTALLPATH)/docs
LIBPATH = $(INSTALLPATH)/lib/$(ARCH)
PROGSRCPATH = $(INSTALLPATH)/progs
PROGPATH = $(PROGSRCPATH)/$(ARCH)

LIBRARYNAME = shapelets
LIBSRCDIR = $(SRCPATH)/shapelets
LIBINCLDIR = $(LIBSRCDIR)/include
LIBOBSDIR = $(LIBPATH)
SRC = $(wildcard $(LIBSRCDIR)/*.cc)
OBJECTS = $(SRC:$(LIBSRCDIR)/%.cc=$(LIBOBSDIR)/%.o)

LENSINGNAME = lensing
LENSINGSRCDIR = $(SRCPATH)/lensing
LENSINGINCLDIR = $(LENSINGSRCDIR)/include
LENSINGLIBOBSDIR = $(LIBPATH)
LENSINGSRC = $(wildcard $(LENSINGSRCDIR)/*.cc)
LENSINGOBJECTS = $(LENSINGSRC:$(LENSINGSRCDIR)/%.cc=$(LENSINGLIBOBSDIR)/%.o)

FRAMENAME = frame
FRAMESRCDIR = $(SRCPATH)/frame
FRAMEINCLDIR = $(FRAMESRCDIR)/include
FRAMELIBOBSDIR = $(LIBPATH)
FRAMESRC = $(wildcard $(FRAMESRCDIR)/*.cc)
FRAMEOBJECTS = $(FRAMESRC:$(FRAMESRCDIR)/%.cc=$(FRAMELIBOBSDIR)/%.o)

PROGS = $(wildcard $(PROGSRCPATH)/*.cc)
PROGSOBJECTS = $(PROGS:$(PROGSRCPATH)/%.cc=$(PROGPATH)/%)

HEADERS = $(wildcard $(LIBINCLDIR)/*.h) $(wildcard $(LENSINGINCLDIR)/*.h) $(wildcard $(FRAMEINCLDIR)/*.h) $(wildcard $(NUMLAINCLPATH)/*.h)

CC = g++
CFLAGS = -ansi -DNDEBUG -g -O???OPTIMIZE??? -Wno-deprecated -march=???MARCH??? -I$(NUMLAINCLDIR) -I$(LIBINCLDIR) -I$(LENSINGINCLDIR) -I$(FRAMEINCLDIR) ???OTHERINCL??? -L$(LIBPATH) ???OTHERLIB???
LIBS = -llensing -lshapelets -lframe -lgsl -llapack_atlas -lcblas -latlas -llapack -lg2c -lCCfits -lcfitsio -lfftw3

AR = ar
ARFLAGS = -sr

.DEFAULT: all

.PHONY: clean

all: shapelets lensing frame progs docs

clean:
	rm -f $(LIBOBSDIR)/lib$(LIBRARYNAME).a
	rm -f $(LENSINGLIBOBSDIR)/lib$(LENSINGNAME).a
	rm -f $(FRAMELIBOBSDIR)/lib$(FRAMENAME).a	
	rm -f $(OBJECTS)
	rm -f $(LENSINGOBJECTS)
	rm -f $(FRAMEOBJECTS)
	rm -f $(PROGSOBJECTS)

cleanshapelets:
	rm -f $(LIBOBSDIR)/lib$(LIBRARYNAME).a
	rm -f $(OBJECTS)
cleanlensing:
	rm -f $(LENSINGLIBOBSDIR)/lib$(LENSINGNAME).a
	rm -f $(LENSINGOBJECTS)
cleanframe:
	rm -f $(FRAMELIBOBSDIR)/lib$(FRAMENAME).a
	rm -f $(FRAMEOBJECTS)
cleanprogs:
	rm -f $(PROGSOBJECTS)

dep:
	$(CC) -MM $(SRC) > $(DEPENDFILE)
	-include $(DEPENDFILE) 

lensing: $(LENSINGLIBOBSDIR)/lib$(LENSINGNAME).a

frame: $(FRAMELIBOBSDIR)/lib$(FRAMENAME).a

shapelets: $(LIBOBSDIR)/lib$(LIBRARYNAME).a 

progs: $(PROGSOBJECTS)

docs: $(HEADERS)
	doxygen Doxyfile

$(LIBOBSDIR)/%.o: $(LIBSRCDIR)/%.cc
	$(CC) $(CFLAGS) -c $< -o $@

$(LENSINGLIBOBSDIR)/%.o: $(LENSINGSRCDIR)/%.cc
	$(CC) $(CFLAGS) -c $< -o $@

$(FRAMELIBOBSDIR)/%.o: $(FRAMESRCDIR)/%.cc
	$(CC) $(CFLAGS) -c $< -o $@

$(PROGPATH)/%: $(PROGSRCPATH)/%.cc
	$(CC) $(CFLAGS) $< -o $@ $(LIBS)

$(LIBOBSDIR)/lib$(LIBRARYNAME).a: $(OBJECTS)
	$(AR) $(ARFLAGS) $@ $?

$(LENSINGLIBOBSDIR)/lib$(LENSINGNAME).a: $(LENSINGOBJECTS) 
	$(AR) $(ARFLAGS) $@ $?

$(FRAMELIBOBSDIR)/lib$(FRAMENAME).a: $(FRAMEOBJECTS) 
	$(AR) $(ARFLAGS) $@ $?

